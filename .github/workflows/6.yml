name: 6_working - Create Wikis
on:
  workflow_dispatch:

permissions:
  contents: write  # âœ… Only this is needed for git push to wiki

jobs:
  create-empty-wikis:
    runs-on: ubuntu-latest
    steps:
      - name: Install tools
        run: sudo apt-get update -qq && sudo apt-get install -y jq git curl

      - name: Create Wikis for EMPTY Repos ONLY
        env:
          USERNAME: Harshad41
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          echo "ğŸ” Scanning repositories..."

          # Wiki template
          HOME_MD=$(cat << 'EOF'
          # Welcome to the Repository Wiki
          
          This wiki contains project documentation and guides.
          
          ## Navigation
          - [Getting Started](Getting-Started)
          - [Configuration](Configuration)
          - [Troubleshooting](Troubleshooting)
          
          **Updated:** $(date +%Y-%m-%d)
          EOF
          )

          # Use associative array to avoid pipe issues
          declare -A needs_wiki
          
          # Scan all repos
          page=1
          while : ; do
            response=$(curl -s -w "\n%{http_code}" \
              -H "Authorization: token $GH_TOKEN" \
              "https://api.github.com/users/$USERNAME/repos?per_page=100&page=$page")
            
            http_code=$(echo "$response" | tail -n1)
            body=$(echo "$response" | head -n-1)
            
            [[ "$http_code" != "200" ]] && { echo "âŒ API Error: $http_code"; exit 1; }
            
            count=$(echo "$body" | jq '. | length')
            [[ "$count" -eq 0 ]] && break

            # Process each repo - FIXED ARRAY POPULATION
            while IFS= read -r line; do
              [[ -z "$line" ]] && continue
              repo=$(echo "$line" | awk '{print $1}')
              has_wiki=$(echo "$line" | awk '{print $2}')
              
              if [[ "$has_wiki" == "false" ]]; then
                echo "ğŸ“ $repo â†’ Wiki DISABLED (SKIPPING as requested)"
              elif [[ "$has_wiki" == "true" ]]; then
                # Check if wiki is actually empty
                wiki_url="https://github.com/$USERNAME/$repo.wiki.git"
                if ! git ls-remote --exit-code --heads "$wiki_url" >/dev/null 2>&1; then
                  echo "ğŸ“ $repo â†’ Wiki enabled but EMPTY/INACCESSIBLE (will create)"
                  needs_wiki["$repo"]=1
                else
                  echo "âœ… $repo â†’ Wiki exists with content (SKIPPING)"
                fi
              fi
            done < <(echo "$body" | jq -r '.[] | "\(.name) \(.has_wiki)"')

            ((page++))
          done

          # Convert to normal array
          needs_wiki_array=("${!needs_wiki[@]}")
          echo ""
          echo "ğŸ“Š Found ${#needs_wiki_array[@]} repositories needing wikis: ${needs_wiki_array[*]}"
          
          # CREATE WIKIS FOR EMPTY REPOS ONLY
          for repo in "${needs_wiki_array[@]}"; do
            echo ""
            echo "ğŸ”„ Creating wiki for $repo..."
            
            TEMP_DIR=$(mktemp -d)
            cd "$TEMP_DIR"
            
            git init
            git checkout -b main || true
            git config user.name "GitHub Actions"
            git config user.email "actions@github.com"
            
            echo "$HOME_MD" > Home.md
            git add Home.md
            git commit -m "Add initial Home.md via GitHub Actions"
            
            git remote add origin "https://x-access-token:$GH_TOKEN@github.com/$USERNAME/$repo.wiki.git"
            if git push -u origin main; then
              echo "âœ… $repo â†’ Wiki created with Home.md"
            else
              echo "âŒ $repo â†’ Push failed"
            fi
            
            cd ..
            rm -rf "$TEMP_DIR"
          done

          echo ""
          echo "ğŸ‰ Wiki creation complete!"

