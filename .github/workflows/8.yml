name: 8 - Create Wikis (DEV BRANCH)

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  create-empty-wikis:
    runs-on: ubuntu-latest
    steps:
      - name: Install tools
        run: sudo apt-get update -qq && sudo apt-get install -y jq git curl

      - name: Create Wikis for EMPTY Repos
        env:
          USERNAME: Harshad41
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          echo "üîç Scanning repositories..."

          HOME_MD=$(cat << 'EOF'
          # Welcome to the Repository Wiki
          
          This wiki contains project documentation and guides.
          
          ## Navigation
          - [Getting Started](Getting-Started)
          - [Configuration](Configuration)
          - [Troubleshooting](Troubleshooting)
          
          **Updated:** $(date +%Y-%m-%d)
          EOF
          )

          # PIPE-FREE: Direct jq processing
          needs_wiki=()
          
          # Get ALL repos as array
          mapfile -t repo_lines < <(
            curl -s -H "Authorization: token $GH_TOKEN" \
              "https://api.github.com/users/$USERNAME/repos?per_page=100" | \
            jq -r '.[] | "\(.name) \(.has_wiki)"'
          )

          # Process WITHOUT PIPE
          for line in "${repo_lines[@]}"; do
            repo=$(echo "$line" | awk '{print $1}')
            has_wiki=$(echo "$line" | awk '{print $2}')
            
            if [[ "$has_wiki" == "false" ]]; then
              echo "üìù $repo ‚Üí Wiki DISABLED (SKIPPING)"
            elif [[ "$has_wiki" == "true" ]]; then
              wiki_url="https://github.com/$USERNAME/$repo.wiki.git"
              if ! git ls-remote --exit-code --heads "$wiki_url" >/dev/null 2>&1; then
                echo "üìù $repo ‚Üí Wiki EMPTY (will create)"
                needs_wiki+=("$repo")
              else
                echo "‚úÖ $repo ‚Üí Wiki exists (SKIPPING)"
              fi
            fi
          done

          echo ""
          echo "üìä Found ${#needs_wiki[@]} repos: ${needs_wiki[*]}"

          # CREATE WIKIS ON DEV BRANCH
          for repo in "${needs_wiki[@]}"; do
            echo "üîÑ Creating wiki for $repo..."
            
            TEMP_DIR=$(mktemp -d)
            cd "$TEMP_DIR"
            
            git init
            git checkout -b dev
            
            git config user.name "GitHub Actions"
            git config user.email "actions@github.com"
            
            echo "$HOME_MD" > Home.md
            git add Home.md
            git commit -m "Add initial Home.md"
            
            git remote add origin "https://$GH_TOKEN@github.com/$USERNAME/$repo.wiki.git"
            
            if git push -u origin dev; then
              echo "‚úÖ $repo ‚Üí Wiki created on dev branch"
            else
              echo "‚ö†Ô∏è  $repo ‚Üí Push failed, retrying..."
              sleep 5
              git push -u origin dev --force && \
                echo "‚úÖ $repo ‚Üí Wiki created after retry" || \
                echo "‚ùå $repo ‚Üí Failed"
            fi
            
            cd ..
            rm -rf "$TEMP_DIR"
            echo ""
          done

          echo "üéâ ALL WIKIS CREATED!"
