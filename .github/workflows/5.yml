name: 3 - Create Wikis (ARRAY FIXED FOREVER)

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  create-empty-wikis:
    runs-on: ubuntu-latest
    steps:
      - name: Install tools
        run: sudo apt-get update -qq && sudo apt-get install -y jq git curl

      - name: Create Wikis for EMPTY Repos ONLY
        env:
          USERNAME: Harshad41
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          echo "üîç Scanning repositories..."

          # Wiki template
          HOME_MD=$(cat << 'EOF'
          # Welcome to the Repository Wiki
          
          This wiki contains project documentation and guides.
          
          ## Navigation
          - [Getting Started](Getting-Started)
          - [Configuration](Configuration)
          - [Troubleshooting](Troubleshooting)
          
          **Updated:** $(date +%Y-%m-%d)
          EOF
          )

          # SIMPLE ARRAY - NO PIPE ISSUES
          needs_wiki=()

          # Get ALL repos in one call
          repos_json=$(curl -s \
            -H "Authorization: token $GH_TOKEN" \
            "https://api.github.com/users/$USERNAME/repos?per_page=100")

          # Process repos DIRECTLY (no pipes!)
          echo "$repos_json" | jq -r '.[] | "\(.name),\(.has_wiki)"' | while IFS=',' read -r repo has_wiki; do
            if [[ "$has_wiki" == "false" ]]; then
              echo "üìù $repo ‚Üí Wiki DISABLED (SKIPPING as requested)"
            elif [[ "$has_wiki" == "true" ]]; then
              # Test wiki existence with ls-remote (fast)
              wiki_url="https://github.com/$USERNAME/$repo.wiki.git"
              if ! git ls-remote --exit-code --heads "$wiki_url" >/dev/null 2>&1; then
                echo "üìù $repo ‚Üí Wiki enabled but EMPTY/INACCESSIBLE (will create)"
                needs_wiki+=("$repo")
              else
                echo "‚úÖ $repo ‚Üí Wiki exists with content (SKIPPING)"
              fi
            fi
          done

          echo ""
          echo "üìä Found ${#needs_wiki[@]} repositories needing wikis"
          
          # CREATE WIKIS
          for repo in "${needs_wiki[@]}"; do
            echo "üîÑ Creating wiki for $repo..."
            
            # Create temp dir and init git
            TEMP_DIR=$(mktemp -d)
            cd "$TEMP_DIR"
            git init
            git checkout -b main
            
            # Config
            git config user.name "GitHub Actions"
            git config user.email "actions@github.com"
            
            # Create Home.md
            echo "$HOME_MD" > Home.md
            git add Home.md
            git commit -m "Add initial Home.md"
            
            # Push to wiki
            git remote add origin "https://x-access-token:$GH_TOKEN@github.com/$USERNAME/$repo.wiki.git"
            if git push -u origin main; then
              echo "‚úÖ $repo ‚Üí Wiki created with Home.md"
            else
              echo "‚ùå $repo ‚Üí Push failed (wiki may still be initializing)"
              sleep 3
              git push -u origin main --force || echo "‚ö†Ô∏è  Retry failed"
            fi
            
            cd ..
            rm -rf "$TEMP_DIR"
            echo ""
          done

          echo "üéâ Wiki creation complete!"
