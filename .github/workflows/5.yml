name: 5-Create-Wikis

on:
  workflow_dispatch:

jobs:
  create-wikis:
    runs-on: ubuntu-latest
    steps:
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq git

      - name: Create Wikis for all repos
        env:
          USERNAME: Harshad41
          GH_TOKEN: ${{ secrets.GH_TOKEN }}  # Use GitHub Secret!
        run: |
          echo "Fetching repositories..."
          page=1
          total_created=0
          total_skipped=0
          
          while : ; do
            response=$(curl -s -w "\n%{http_code}" -H "Authorization: Bearer $GH_TOKEN" \
              "https://api.github.com/users/$USERNAME/repos?per_page=100&page=$page")
            http_code=$(echo "$response" | tail -n1)
            body=$(echo "$response" | head -n-1)
            
            if [ "$http_code" != "200" ]; then
              echo "Error: HTTP $http_code"
              echo "$body" | jq .
              exit 1
            fi
            
            count=$(echo "$body" | jq '. | length')
            if [ "$count" -eq 0" ]; then
              break
            fi
            
            echo "$body" | jq -r '.[] | "\(.name) \(.has_wiki)"' | while read repo has_wiki; do
              echo ""
              echo "Processing repo: $repo (wiki: $has_wiki)"
              
              # Skip if wiki is disabled
              if [ "$has_wiki" = "false" ]; then
                echo "  â†’ Enabling wiki..."
                curl -s -X PATCH -H "Authorization: Bearer $GH_TOKEN" \
                  -H "Accept: application/vnd.github+json" \
                  "https://api.github.com/repos/$USERNAME/$repo" \
                  -d '{"wiki": true}' > /dev/null
                
                if [ $? -eq 0 ]; then
                  echo "  âœ… Wiki enabled for $repo"
                else
                  echo "  âŒ Failed to enable wiki for $repo"
                  continue
                fi
              fi
              
              # Check if wiki already has content
              wiki_git_url="https://github.com/$USERNAME/$repo.wiki.git"
              temp_dir=$(mktemp -d)
              
              if git clone --quiet --depth 1 "$wiki_git_url" "$temp_dir" 2>/dev/null; then
                # Check if wiki has actual content (excluding .git)
                if find "$temp_dir" -maxdepth 1 -type f -not -path "$temp_dir/.git/*" | grep -q .; then
                  echo "  âœ… $repo â†’ Wiki exists with content (SKIPPED)"
                  ((total_skipped++))
                else
                  echo "  ðŸ“ $repo â†’ Wiki empty, creating Home.md..."
                fi
              else
                echo "  ðŸ“ $repo â†’ Wiki new/empty, creating Home.md..."
              fi
              
              # Clean up clone
              rm -rf "$temp_dir"
              
              # Create wiki content only if empty/new
              if ! git clone --quiet --depth 1 "$wiki_git_url" "$temp_dir" 2>/dev/null || \
                 ! find "$temp_dir" -maxdepth 1 -type f -not -path "$temp_dir/.git/*" | grep -q .; then
                
                # Create Home.md content
                cat > "$temp_dir/Home.md" << 'EOF'
# Welcome to the Repository Wiki

This wiki serves as documentation for the **$(basename $repo)** repository.

## Quick Start
- **Repository**: https://github.com/Harshad41/$(basename $repo)
- **Purpose**: [Add description here]
- **Tech Stack**: [List technologies used]

## Table of Contents
- [Getting Started](#getting-started)
- [Deployment](#deployment)
- [Configuration](#configuration)
- [Troubleshooting](#troubleshooting)

## Getting Started
