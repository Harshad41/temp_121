name: 5-Create-Wikis

on:
  workflow_dispatch:

jobs:
  create-wikis:
    runs-on: ubuntu-latest
    steps:
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq git

      - name: Create Wikis for all repos
        env:
          USERNAME: Harshad41
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          echo "Fetching repositories..."
          page=1
          total_created=0
          total_skipped=0
          
          while : ; do
            response=$(curl -s -w "\n%{http_code}" -H "Authorization: Bearer $GH_TOKEN" \
              "https://api.github.com/users/$USERNAME/repos?per_page=100&page=$page")
            http_code=$(echo "$response" | tail -n1)
            body=$(echo "$response" | head -n-1)
            
            if [ "$http_code" != "200" ]; then
              echo "Error: HTTP $http_code"
              echo "$body" | jq .
              exit 1
            fi
            
            count=$(echo "$body" | jq '. | length')
            if [ "$count" -eq 0 ]; then
              break
            fi
            
            echo "$body" | jq -r '.[] | "\(.name) \(.has_wiki)"' | while read repo has_wiki; do
              echo ""
              echo "Processing repo: $repo (wiki: $has_wiki)"
              
              if [ "$has_wiki" = "false" ]; then
                echo "  ‚Üí Enabling wiki..."
                curl -s -X PATCH \
                  -H "Authorization: Bearer $GH_TOKEN" \
                  -H "Accept: application/vnd.github+json" \
                  "https://api.github.com/repos/$USERNAME/$repo" \
                  -d '{"wiki": true}' > /dev/null || true
                echo "  ‚úÖ Wiki enabled for $repo"
              fi
              
              wiki_git_url="https://github.com/$USERNAME/$repo.wiki.git"
              temp_dir=$(mktemp -d)
              has_content=false
              
              if git clone --quiet --depth 1 "$wiki_git_url" "$temp_dir" 2>/dev/null; then
                if find "$temp_dir" -maxdepth 1 -type f ! -name ".git" | grep -q .; then
                  echo "  ‚úÖ $repo ‚Üí Wiki exists (SKIPPED)"
                  ((total_skipped++))
                  has_content=true
                fi
              fi
              
              rm -rf "$temp_dir"
              
              if [ "$has_content" = "false" ]; then
                echo "  üìù Creating wiki for $repo..."
                temp_dir=$(mktemp -d)
                
                cat > "$temp_dir/Home.md" << EOF
# $repo Wiki

## Quick Start
- **Repository**: https://github.com/Harshad41/$repo
- **Clone**: \`git clone https://github.com/Harshad41/$repo.git\`

## Contents
- [Getting Started](#getting-started)
- [Deployment](#deployment)

*Generated: $(date)*
EOF

                cd "$temp_dir" || exit 1
                git init
                git config user.name "GitHub Actions"
                git config user.email "actions@github.com"
                git remote add origin "$wiki_git_url"
                git checkout -b main || git checkout -b master
                git add Home.md
                git commit -m "Add initial Home.md"
                git push -u origin main 2>/dev/null || git push -u origin master 2>/dev/null || echo "  ‚ö†Ô∏è Push failed"
                
                echo "  ‚úÖ $repo ‚Üí Wiki created!"
                ((total_created++))
                
                cd ..
                rm -rf "$temp_dir"
              fi
            done
            
            page=$((page + 1))
          done
          
          echo ""
          echo "=== SUMMARY ==="
          echo "Created: $total_created | Skipped: $total_skipped"
